<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>Pinned Cross-Reveal + Real Next Section Cover</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js"></script>

    <!-- 데모용 폰트 -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@600&family=Noto+Serif+KR:wght@700&display=swap"
      rel="stylesheet"
    />

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
      }
      body {
        font-family: 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto,
          sans-serif;
        background: #d6d2c4;
        color: #111;
      }
      .spacer {
        height: 80vh;
        display: grid;
        place-items: center;
      }

      /* ===== 핀되는 섹션 ===== */
      .pin-wrap {
        height: 100vh;
        display: grid;
        place-items: center;
      }
      .inner {
        width: min(86vw, 1100px);
        height: min(88vh, 900px);
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 20px;
      }

      .typo {
        position: relative;
        height: clamp(60px, 16vh, 140px);
        overflow: hidden;
      }
      .title {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        font: 700 clamp(26px, 5.5vw, 56px) / 1.08 'Noto Serif KR', serif;
        opacity: 0;
        transform: translateY(10px);
      }
      .title.is-active {
        opacity: 1;
        transform: translateY(0);
      }

      .stage {
        position: relative;
        width: 100%;
        aspect-ratio: 16/9;
        overflow: hidden;
        border-radius: 14px;
        background: #000;
        box-shadow: 0 12px 36px rgba(0, 0, 0, 0.18);
      }
      .stage img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: translateY(0%);
      }
      .stage img:nth-child(1) {
        z-index: 4;
      }
      .stage img:nth-child(2) {
        z-index: 3;
      }
      .stage img:nth-child(3) {
        z-index: 2;
      }
      .stage img:nth-child(4) {
        z-index: 1;
      }

      /* ===== 실제 next 섹션 ===== */
      .next-placeholder {
        height: 0;
      } /* next가 고정될 때 흐름 유지용 플레이스홀더 */

      .next {
        background: #f7f4ea;
        color: #1b1b1b;
        min-height: 100vh;
        padding: clamp(28px, 6vw, 64px) 6vw;
        position: relative;
        z-index: 0; /* 평소엔 일반 흐름 */
        will-change: transform;
      }
      /* 덮기 애니메이션 동안만 고정 오버레이로 변신 */
      .next.is-overlay {
        position: fixed;
        inset: 0;
        z-index: 10;
        transform: translateY(
          100%
        ); /* 화면 아래 대기 상태 (GSAP이 yPercent로 제어) */
      }

      .next h2 {
        font: 700 clamp(26px, 4.8vw, 48px) / 1.1 'Noto Serif KR', serif;
        margin: 0 0 12px;
      }
      .next p {
        max-width: 72ch;
        line-height: 1.7;
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div class="spacer"><h2>위 컨텐츠</h2></div>

    <section class="pin-wrap">
      <div class="inner">
        <div class="typo" id="typo">
          <h2 class="title is-active">World First Climate Control</h2>
        </div>

        <div class="stage" id="stage">
          <img src="https://picsum.photos/id/1015/1600/900" alt="" />
          <img src="https://picsum.photos/id/1025/1600/900" alt="" />
          <img src="https://picsum.photos/id/1035/1600/900" alt="" />
          <img src="https://picsum.photos/id/1043/1600/900" alt="" />
        </div>
      </div>
    </section>

    <!-- next가 고정으로 빠지는 동안 레이아웃 유지용 -->
    <div class="next-placeholder" id="nextPH"></div>

    <!-- 진짜 next 섹션(이 요소 자체가 올라와서 덮음) -->
    <section class="next" id="next">
      <h2>Adaptive Living Spaces</h2>
      <p>
        실내/실외 데이터를 통합 분석해 시간대·활동·재실 인원 변화에 맞춰
        온도·습도·공기 흐름을 능동적으로 조율합니다. 이 섹션은 위의 핀 구간
        막바지에 화면 아래에서 올라와 ‘직접’ 덮습니다.
      </p>
      <div style="height: 120vh"></div>
    </section>

    <script>
      gsap.registerPlugin(ScrollTrigger);

      const stageImgs = gsap.utils.toArray('#stage img');
      const next = document.getElementById('next');
      const nextPH = document.getElementById('nextPH');

      // 스크롤/감도
      const steps = stageImgs.length - 1; // 이미지 교차 횟수
      const SPEED = 1.6; // 느리게 하려면 ↑
      const SCRUB = 1.2;

      // 핀 + 이미지 교차 전환
      const tl = gsap.timeline({
        defaults: { ease: 'none' },
        scrollTrigger: {
          trigger: '.pin-wrap',
          start: 'top top',
          end: '+=' + window.innerHeight * steps * SPEED,
          scrub: SCRUB,
          pin: true,
          anticipatePin: 1,
        },
      });

      // 위에서부터 한 장씩 들어올리기
      stageImgs.forEach((img, i) => {
        if (i === stageImgs.length - 1) return;
        tl.to(img, { yPercent: -100, duration: 1 }, i);
      });

      // ====== 여기부터 핵심: next 섹션이 '진짜로' 올라와 덮기 ======
      // 덮기 시작 타이밍(필요에 따라 조절: 숫자 클수록 더 늦게 덮기 시작)
      const coverStart = Math.max(0, steps - 0.7);

      // overlay 모드 토글 함수(레이아웃 점프 방지용 플레이스홀더 포함)
      function setOverlay(on) {
        if (on) {
          nextPH.style.height = next.offsetHeight + 'px'; // 흐름 유지
          next.classList.add('is-overlay');
          gsap.set(next, { yPercent: 100 }); // 화면 아래 대기
        } else {
          next.classList.remove('is-overlay');
          gsap.set(next, { clearProps: 'transform' });
          nextPH.style.height = '0px';
        }
      }

      // next를 화면 아래(100%) → 0%로 끌어올려 덮기
      tl.fromTo(
        next,
        { yPercent: 100 },
        {
          yPercent: 0,
          duration: 0.8,
          onStart: () => setOverlay(true),
          onReverseComplete: () => setOverlay(false),
        },
        coverStart
      );

      // 핀이 끝나고 흐름으로 자연 전환
      tl.eventCallback('onComplete', () => setOverlay(false));

      // 위로 스크롤해서 핀 구간으로 다시 들어오면 다시 overlay
      ScrollTrigger.create({
        trigger: '.pin-wrap',
        start: 'bottom bottom',
        end: 'bottom top',
        onEnterBack: () => setOverlay(true),
        onLeave: () => setOverlay(false),
      });

      addEventListener('resize', () => {
        if (!next.classList.contains('is-overlay')) nextPH.style.height = '0px';
        ScrollTrigger.refresh();
      });
    </script>
  </body>
</html>
